<%- include('../partials/header') %>

<h2>Richieste Informative dalle Aziende</h2>

<% if (success_msg) { %>
  <div class="alert alert-success"><%= success_msg %></div>
<% } %>
<% if (error_msg) { %>
  <div class="alert alert-danger"><%= error_msg %></div>
<% } %>

<p><a href="/admin/info-requests/archive">📁 Vai all’archivio richieste</a></p>


<% if (requests.length === 0) { %>
  <p>Nessuna richiesta aperta.</p>
<% } else { %>
  <% requests.forEach(r => { %>
    <div class="request-preview" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong><%= r.company.firstname %> <%= r.company.lastname %></strong>
        <button onclick="toggleMsg('<%= r._id %>')" id="toggle-btn-<%= r._id %>">👁️ Mostra</button>
      </div>

      <div class="request-full" id="msg-<%= r._id %>" style="display: none; margin-top: 10px;">
        <p><strong>Email:</strong> <%= r.company.email %></p>
        <p><strong>Messaggio:</strong></p>
        <pre><%= r.message %></pre>

        <form method="POST" action="/admin/info-requests/<%= r._id %>/send">
          <label for="replyMessage">Risposta via email:</label><br>
          <textarea name="replyMessage" rows="4" required style="width: 100%;"></textarea><br><br>
          <button type="submit">📤 Invia risposta</button>
        </form>

        <form method="POST" action="/admin/info-requests/<%= r._id %>/archive" style="display:inline;">
          <button type="submit">📦 Archivia</button>
        </form>

        <form method="POST" action="/admin/info-requests/<%= r._id %>/delete" style="display:inline;" onsubmit="return confirm('Sei sicuro di voler eliminare questa richiesta?');">
          <button type="submit">🗑️ Elimina</button>
        </form>
      </div>
    </div>
  <% }) %>
<% } %>

<script>
  function toggleMsg(id) {
    const section = document.getElementById('msg-' + id);
    const btn = document.getElementById('toggle-btn-' + id);
    const isOpen = section.style.display === 'block';
    section.style.display = isOpen ? 'none' : 'block';
    btn.textContent = isOpen ? '👁️ Mostra' : '👁️‍🗨️ Nascondi';
  }
</script>

<%- include('../partials/footer') %>
