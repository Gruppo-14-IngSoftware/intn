<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title><%= locals.title %></title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
</head>
<style>
    body {
        font-family: sans-serif;
        margin: 0 auto;
        max-width: 700px;
        padding: 1rem;
        background: #f9f9f9;
    }

    .eventImage {
        width: 100%;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .eventTitle {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .eventDetails {
        color: #555;
        margin-bottom: 1rem;
    }

    .eventBox i {
        cursor: pointer;
        font-size: 1.4rem;
        color: #444;
        transition: color 0.2s;
    }

    .eventBox i:hover {
        color: #000;
    }

    .comment-box textarea {
        width: 100%;
        padding: 0.5rem;
        resize: vertical;
        font-size: 1rem;
    }

    .comment-box button {
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
    }

    .eventGallery img {
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #map { height: 400px; border-radius: 10px; margin-bottom: 20px; }
</style>
<body>
<% if (Array.isArray(locals.images) && locals.images.length > 0) { %>
    <div id="eventCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
        <div class="carousel-inner" style="border-radius: 10px; overflow: hidden;">
            <% locals.images.forEach(function(img, index) { %>
                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                    <img src="<%= img %>" class="d-block w-100 eventImage" alt="Immagine evento <%= index + 1 %>" />
                </div>
            <% }); %>
        </div>
        <% if (locals.images.length > 1) { %>
            <button class="carousel-control-prev" type="button" data-bs-target="#eventCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Precedente</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#eventCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Successivo</span>
            </button>
        <% } %>
    </div>
<% } else { %>
    <img src="<%= locals.image || '/images/default.jpg' %>" alt="Immagine evento" class="eventImage" />
<% } %>

<div class="eventTitle"><%= locals.title %></div>
<% if (locals.tag) { %>
    <div class="mb-3">
        <span class="badge bg-primary"><%= locals.tag %></span>
    </div>
<% } %>

<div class="eventDetails">
    <p><strong>Data:</strong> <%= locals.date %></p>
    <p><strong>Luogo:</strong> <%= locals.location %></p>
    <p><%= locals.description %></p>
</div>

<p class="text-muted">Creato da: <strong><%= locals.createdBy %></strong></p>
<p><strong>Evento verificato:</strong> <%= locals.verified ? "SI" : "NO" %></p>

<div id="map" style="height: 300px; margin-top: 20px;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
    mapboxgl.accessToken = "<%= mapboxToken %>";

    const position = "<%= locals.location %>";

    fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
            position
        )}.json?access_token=${mapboxgl.accessToken}`
    )
        .then((res) => res.json())
        .then((data) => {
            const coords = data.features[0].center;

            const map = new mapboxgl.Map({
                container: "map",
                style: "mapbox://styles/mapbox/streets-v12",
                center: coords,
                zoom: 13,
            });

            new mapboxgl.Marker().setLngLat(coords).setPopup(new mapboxgl.Popup().setText(position)).addTo(map);
        })
        .catch((err) => {
            console.error("Errore geocoding:", err);
            document.getElementById("map").innerText = "Mappa non disponibile";
        });
</script>
</body>
</html>
